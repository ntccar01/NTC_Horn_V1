<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ±½è»Šå–‡å­é›»è·¯æ•™å­¸æ¨¡æ“¬ - V1 (ç·´ç¿’ã€è€ƒè©•å®Œæ•´ç‰ˆ)</title>
    <style>
        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            background-color: #2c3e50; 
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; 
            height: 100vh;
            user-select: none;
        }
        h2 { color: #ecf0f1; margin-bottom: 5px; }
        .status-bar { color: #bdc3c7; font-size: 14px; margin-bottom: 10px; height: 20px; display: flex; gap: 20px;}
        .student-info { color: #f1c40f; font-weight: bold; }
        .mode-indicator { font-weight: bold; padding: 2px 8px; border-radius: 4px; }
        .mode-practice { background: #3498db; color: white; }
        .mode-exam { background: #e74c3c; color: white; }
        
        .main-layout { display: flex; gap: 20px; background-color: #ecf0f1; padding: 20px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; }
        .circuit-area { position: relative; background-color: white; border: 2px solid #bdc3c7; border-radius: 8px; }
        .meter-area { position: relative; width: 300px; height: 600px; background-color: #34495e; border-radius: 8px; border: 2px solid #2c3e50; }
        svg { overflow: visible; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 30px; border-radius: 10px; width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal-box h2 { color: #2c3e50; margin-top: 0; margin-bottom: 20px; }
        
        .mode-selection-btns { display: flex; flex-direction: column; gap: 15px; }
        .btn-mode { padding: 15px; font-size: 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; transition: transform 0.1s; }
        .btn-mode:active { transform: scale(0.98); }
        .btn-practice { background-color: #3498db; }
        .btn-practice:hover { background-color: #2980b9; }
        .btn-exam { background-color: #e74c3c; }
        .btn-exam:hover { background-color: #c0392b; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .btn-primary { background-color: #27ae60; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 5px; cursor: pointer; width: 100%; transition: background 0.2s; }
        .btn-primary:hover { background-color: #219150; }
        .btn-back { background: transparent; border: none; color: #7f8c8d; cursor: pointer; margin-top: 10px; text-decoration: underline; }

        .radio-group { text-align: left; margin: 20px 0; max-height: 300px; overflow-y: auto; }
        .radio-item { margin-bottom: 10px; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        .radio-item:hover { background-color: #f7f9f9; }
        .radio-item label { cursor: pointer; width: 100%; display: block; }
        .result-success { color: #27ae60; font-size: 24px; font-weight: bold; }
        .result-fail { color: #c0392b; font-size: 24px; font-weight: bold; }
        
        .controls-container { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px; z-index: 100; }
        .action-btn { padding: 10px 16px; color: white; border: none; border-radius: 5px; font-family: "Microsoft JhengHei"; font-size: 14px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .btn-fault { background-color: #3498db; } .btn-fault:hover { background-color: #2980b9; }
        .btn-submit { background-color: #27ae60; } .btn-submit:hover { background-color: #219150; }
        .btn-switch { background-color: #8e44ad; } .btn-switch:hover { background-color: #732d91; }
        .btn-guide { background-color: #e67e22; } .btn-guide:hover { background-color: #d35400; }
        
        .clear-btn { position: absolute; bottom: 15px; left: 15px; padding: 8px 16px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; }
        
        #faultPanel { position: absolute; top: 20px; left: -250px; width: 230px; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); transition: left 0.3s; z-index: 200; max-height: 80vh; overflow-y: auto; }
        #faultPanel.visible { left: 20px; }
        #faultPanel h3 { margin-top: 0; font-size: 16px; color: #f1c40f; }
        #faultPanel label { display: block; margin-top: 10px; font-size: 14px; }
        #faultPanel select { width: 100%; padding: 5px; margin-top: 3px; border-radius: 4px; }
        
        .result-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-upload { background-color: #8e44ad; color: white; flex: 1; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }
        .btn-download { background-color: #2c3e50; color: white; flex: 1; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }
        .btn-restart { background-color: #95a5a6; color: white; flex: 1; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }

        .hidden { display: none !important; }

        .component-body { fill: #fff; stroke: #000; stroke-width: 2; }
        .component-internal { fill: none; stroke: #000; stroke-width: 2; pointer-events: none; transition: stroke 0.3s; }
        .fusible-link-wire { fill: none; stroke: #000; stroke-width: 4; pointer-events: none; transition: stroke 0.3s; }
        .relay-coil-path { fill: none; stroke: #000; stroke-width: 2; transition: stroke 0.2s; }
        .relay-switch-path { fill: none; stroke: #000; stroke-width: 2; transition: stroke 0.2s; }
        .relay-switch-blade { stroke: #000; stroke-width: 2; transition: all 0.1s; transform-origin: 40px 80px; }
        .relay-active .relay-coil-path { stroke: #007bff; stroke-width: 3; }
        .relay-active .relay-switch-blade { transform: rotate(15deg); stroke: #28a745; }
        @keyframes flow { to { stroke-dashoffset: -20; } }
        .wire { fill: none; stroke: #d32f2f; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; pointer-events: none; transition: stroke 0.3s; }
        .wire.flowing { stroke: #ff5722; stroke-dasharray: 10, 5; animation: flow 0.5s linear infinite; stroke-width: 4; }
        .component-internal.flowing, .fusible-link-wire.flowing, .relay-switch-path.flowing, .relay-coil-path.flowing { stroke: #ff5722; stroke-width: 3; stroke-dasharray: 8, 4; animation: flow 0.5s linear infinite; }
        .relay-coil-path.flowing { stroke: #ff5722; stroke-dasharray: none; animation: none; }
        .wire-preview { fill: none; stroke: #ff9800; stroke-width: 2; stroke-dasharray: 5,5; pointer-events: none; }
        .wifi-signal { display: none; } .honking .wifi-signal { display: block; }
        .wifi-arc { fill: none; stroke: #ff9800; stroke-width: 3; stroke-linecap: round; opacity: 0.2; }
        .honking .wifi-arc { animation: wifi-blink 0.6s infinite ease-in-out; }
        .honking .arc1 { animation-delay: 0s; } .honking .arc2 { animation-delay: 0.15s; } .honking .arc3 { animation-delay: 0.3s; }
        @keyframes wifi-blink { 0% {opacity:0.2; stroke-width:3;} 50% {opacity:1; stroke-width:4; stroke:#ff5722;} 100% {opacity:0.2; stroke-width:3;} }
        .conn-point { fill: #fff; stroke: #007bff; stroke-width: 2; cursor: pointer; transition: all 0.1s; }
        .conn-point:hover { fill: #007bff; r: 7; }
        .conn-point.active { fill: #28a745; stroke: #28a745; r: 7; }
        .conn-point.probing { fill: #e74c3c !important; stroke: #c0392b !important; r: 8; }
        .btn-pressed .btn-plunger { transform: translateY(5px); transition: transform 0.1s; }
        #btn-hitbox { cursor: pointer; }
        .meter-body { fill: #f1c40f; stroke: #f39c12; stroke-width: 3; rx: 15; } .meter-face-plate { fill: #222; } .meter-screen { fill: #bdc3c7; stroke: #7f8c8d; stroke-width: 2; } .meter-text { font-family: 'Courier New', monospace; font-weight: bold; fill: #2c3e50; } .scale-tick { fill: #f1c40f; } .scale-label { font-size: 10px; fill: #ecf0f1; text-anchor: middle; font-weight: bold; cursor: pointer; transition: fill 0.2s; } .scale-label:hover { fill: #f39c12; } .scale-group { cursor: pointer; } .meter-knob-body { fill: #111; stroke: #333; stroke-width: 1; } .meter-knob-indicator { fill: #ecf0f1; } .meter-knob-grip { fill: none; stroke: #333; stroke-width: 2; } .meter-jack { fill: #ecf0f1; stroke: #95a5a6; stroke-width: 2; } .meter-jack-inner { fill: #34495e; } .probe-wire { fill: none; stroke-width: 4; stroke-linecap: round; pointer-events: none; } .probe-plug { cursor: grab; transition: transform 0.1s; } .probe-plug:active { cursor: grabbing; } .probe-tip { cursor: grab; transition: transform 0.1s linear; transform-origin: 0 0; } .probe-tip:active { cursor: grabbing; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-box">
            <h2>ğŸš— æ±½è»Šå–‡å­é›»è·¯æ•™å­¸ç³»çµ±</h2>
            <div id="stepSelectMode">
                <p>è«‹é¸æ“‡æ“ä½œæ¨¡å¼</p>
                <div class="mode-selection-btns">
                    <button class="btn-mode btn-practice" onclick="choosePracticeMode()">ğŸ”¨ é€²å…¥ç·´ç¿’æ¨¡å¼</button>
                    <button class="btn-mode btn-exam" onclick="chooseExamMode()">ğŸ“ é€²å…¥è€ƒè©•æ¨¡å¼</button>
                </div>
            </div>
            <div id="stepLogin" class="hidden">
                <p>è«‹è¼¸å…¥è€ƒç”Ÿè³‡æ–™</p>
                <form id="loginForm">
                    <div class="form-group"><label>ç­ç´š</label><input type="text" id="inputClass" required></div>
                    <div class="form-group"><label>å§“å</label><input type="text" id="inputName" required></div>
                    <div class="form-group"><label>åº§è™Ÿ</label><input type="number" id="inputSeat" required></div>
                    <div class="form-group">
                        <label>è©¦å·åˆ¥</label>
                        <select id="inputPaper">
                            <option value="0">A å·</option>
                            <option value="2">B å·</option>
                            <option value="4">C å·</option>
                            <option value="6">D å·</option>
                            <option value="1">E å·</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">é–‹å§‹è€ƒè©•</button>
                    <button type="button" class="btn-back" onclick="backToModeSelect()">è¿”å›ä¸Šä¸€é </button>
                </form>
            </div>
        </div>
    </div>

    <div id="quizModal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2>ğŸ“ æäº¤è¨ºæ–·å ±å‘Š</h2>
            <p>è«‹æ ¹æ“šæª¢æ¸¬çµæœï¼Œé¸æ“‡é›»è·¯çš„æ•…éšœåŸå› ï¼š</p>
            <div class="radio-group">
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="normal"> é›»è·¯åŠŸèƒ½æ­£å¸¸</label></div>
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="fuse_link_open"> æ˜“ç†”çµ²æ–·è·¯</label></div>
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="fuse_open"> ä¿éšªçµ²æ–·è·¯</label></div>
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="relay_coil_open"> ç¹¼é›»å™¨ç·šåœˆæ–·è·¯ (85-86)</label></div>
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="relay_switch_fail"> ç¹¼é›»å™¨é–‹é—œæ¥é»æ•…éšœ (30-87)</label></div>
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="btn_open"> æŒ‰éˆ•é–‹é—œå…§éƒ¨æ–·è·¯</label></div>
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="horn1_open"> ä¸Šå–‡å­å…§éƒ¨ç·šåœˆæ–·è·¯</label></div>
                <div class="radio-item"><label><input type="radio" name="diagnosis" value="horn2_open"> ä¸‹å–‡å­å…§éƒ¨ç·šåœˆæ–·è·¯</label></div>
            </div>
            <button id="confirmSubmitBtn" class="btn-primary">ç¢ºèªé€å‡º</button>
            <button id="cancelSubmitBtn" style="margin-top:10px; background:#95a5a6; border:none; padding:8px; width:100%; border-radius:5px; cursor:pointer; color:white;">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="resultModal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 id="resultTitle">è¨ºæ–·çµæœ</h2>
            <p id="resultText"></p>
            <div id="resultDetails" style="text-align:left; background:#ecf0f1; padding:10px; border-radius:5px; margin-bottom:20px;"></div>
            <div class="result-actions">
                <button onclick="uploadToGoogle()" class="btn-upload">â˜ï¸ ä¸Šå‚³æˆç¸¾</button>
                <button onclick="downloadCSV()" class="btn-download">ğŸ’¾ ä¸‹è¼‰ CSV</button>
                <button onclick="location.reload()" class="btn-restart">ğŸ”„ é‡æ–°é–‹å§‹</button>
            </div>
        </div>
    </div>

    <h2>éšæ®µäº” (V50)ï¼šè¦–è¦ºå°é½Šå®Œç¾ç‰ˆ</h2>
    <div class="status-bar">
        <span id="modeDisplay" class="mode-indicator">ç­‰å¾…ç™»å…¥</span>
        <span id="studentDisplay"></span>
        <span id="statusMsg">è«‹é€£æ¥ç·šè·¯é€²è¡Œæ¸¬è©¦ã€‚</span>
    </div>

    <div class="main-layout">
        <div class="circuit-area">
            <svg id="circuitSvg" width="800" height="500" viewBox="0 0 800 500">
                <g id="wire-layer"></g>
                <defs>
                    <g id="std-ground"><line x1="0" y1="0" x2="0" y2="20" stroke="black" stroke-width="2"/><line x1="-15" y1="20" x2="15" y2="20" style="stroke:#000;stroke-width:2;stroke-linecap:round;"/><line x1="-10" y1="25" x2="10" y2="25" style="stroke:#000;stroke-width:2;stroke-linecap:round;"/><line x1="-5" y1="30" x2="5" y2="30" style="stroke:#000;stroke-width:2;stroke-linecap:round;"/></g>
                    <g id="wifi-icon-template"><path class="wifi-arc arc1" d="M 0 -12 Q 16 0 0 12" stroke-width="4"/><path class="wifi-arc arc2" d="M 10 -24 Q 36 0 10 24" stroke-width="4"/><path class="wifi-arc arc3" d="M 20 -36 Q 56 0 20 36" stroke-width="4"/></g>
                </defs>
                
                <g id="battery" transform="translate(50, 290)"><rect width="60" height="100" class="component-body"/><text x="30" y="50" class="text-label" dominant-baseline="middle" text-anchor="middle" dy="1">é›»ç“¶</text><circle cx="30" cy="0" r="4" class="conn-point" data-id="bat_pos"/><circle cx="30" cy="100" r="4" class="conn-point" data-id="bat_neg"/><use href="#std-ground" x="30" y="105"/></g>
                
                <g id="fusible_link" transform="translate(80, 140)"><path id="path_fusible_link" d="M0,10 Q10,0 20,10 T40,10 T60,10 T80,10" class="fusible-link-wire"/><circle cx="0" cy="10" r="4" class="conn-point" data-id="fuse_link_in"/><circle cx="80" cy="10" r="4" class="conn-point" data-id="fuse_link_out"/></g>
                
                <g id="fuse" transform="translate(255, 140)"><path id="path_fuse" d="M0,10 Q6.25,0 12.5,10 T25,10 T37.5,10 T50,10" class="component-internal"/><circle cx="0" cy="10" r="4" class="conn-point" data-id="fuse_in"/><circle cx="50" cy="10" r="4" class="conn-point" data-id="fuse_out"/></g>
                
                <g id="relay" transform="translate(400, 70)">
                    <rect width="120" height="100" class="component-body"/>
                    <line id="path_relay_coil_1" x1="-5" y1="40" x2="30" y2="40" class="relay-coil-path"/><path id="path_relay_coil_2" d="M30,40 Q35,25 40,40 Q45,55 50,40 Q55,25 60,40 Q65,55 70,40 Q75,25 80,40 Q85,55 90,40" class="relay-coil-path" fill="none"/><line id="path_relay_coil_3" x1="90" y1="40" x2="125" y2="40" class="relay-coil-path"/>
                    <line id="path_relay_sw_1" x1="-5" y1="80" x2="40" y2="80" class="relay-switch-path"/><line id="path_relay_sw_2" x1="90" y1="80" x2="125" y2="80" class="relay-switch-path"/><line x1="40" y1="80" x2="85" y2="65" class="relay-switch-blade"/><circle cx="40" cy="80" r="2" fill="black"/>
                    <circle cx="-5" cy="40" r="4" class="conn-point" data-id="relay_86"/><circle cx="125" cy="40" r="4" class="conn-point" data-id="relay_85"/><circle cx="-5" cy="80" r="4" class="conn-point" data-id="relay_30"/><circle cx="125" cy="80" r="4" class="conn-point" data-id="relay_87"/>
                </g>
                
                <g id="button" transform="translate(650, 80)">
                    <rect width="80" height="60" class="component-body" pointer-events="none"/><line x1="-5" y1="30" x2="30" y2="30" class="component-internal" pointer-events="none"/><line x1="50" y1="30" x2="85" y2="30" class="component-internal" pointer-events="none"/><g class="btn-plunger"><line x1="30" y1="20" x2="50" y2="20" stroke="black" stroke-width="3" pointer-events="none"/><line x1="40" y1="20" x2="40" y2="10" stroke="black" stroke-width="2" pointer-events="none"/></g>
                    <circle cx="30" cy="30" r="3" fill="black" pointer-events="none"/><circle cx="50" cy="30" r="3" fill="black" pointer-events="none"/><circle cx="-5" cy="30" r="4" class="conn-point" data-id="btn_in"/><circle cx="85" cy="30" r="4" class="conn-point" data-id="btn_out"/>
                    <line x1="90" y1="30" x2="115" y2="30" stroke="black" stroke-width="2" pointer-events="none"/><line x1="115" y1="30" x2="115" y2="60" stroke="black" stroke-width="2" pointer-events="none"/><use href="#std-ground" x="115" y="60" pointer-events="none"/><rect id="btn-hitbox" x="20" y="10" width="40" height="40" fill="transparent" />
                </g>
                <g id="horn1" transform="translate(650, 200)">
                    <path d="M20,20 L60,0 L60,80 L20,60 L0,60 L0,20 Z" class="component-body"/><path d="M60,20 Q80,40 60,60" fill="none" stroke="black" stroke-width="2"/><circle cx="0" cy="40" r="4" class="conn-point" data-id="horn1_in"/>
                    <line x1="20" y1="60" x2="20" y2="86" stroke="black" stroke-width="2" /><circle cx="20" cy="90" r="4" class="conn-point" data-id="horn1_gnd"/><line x1="20" y1="94" x2="20" y2="110" stroke="black" stroke-width="2" /><use href="#std-ground" x="20" y="110"/><g class="wifi-signal" transform="translate(70, 40)"><use href="#wifi-icon-template"/></g>
                </g>
                <g id="horn2" transform="translate(650, 400)">
                    <path d="M20,20 L60,0 L60,80 L20,60 L0,60 L0,20 Z" class="component-body"/><path d="M60,20 Q80,40 60,60" fill="none" stroke="black" stroke-width="2"/><circle cx="0" cy="40" r="4" class="conn-point" data-id="horn2_in"/>
                    <line x1="20" y1="60" x2="20" y2="86" stroke="black" stroke-width="2" /><circle cx="20" cy="90" r="4" class="conn-point" data-id="horn2_gnd"/><line x1="20" y1="94" x2="20" y2="110" stroke="black" stroke-width="2" /><use href="#std-ground" x="20" y="110"/><g class="wifi-signal" transform="translate(70, 40)"><use href="#wifi-icon-template"/></g>
                </g>
            </svg>
            <button id="clearBtn" class="clear-btn">æ¸…é™¤é€£ç·š</button>
            <div class="controls-container">
                <button id="faultBtn" class="action-btn btn-fault hidden">æ•…éšœè¨­å®š</button>
                <button id="toExamBtn" class="action-btn btn-switch hidden" onclick="switchModeToExam()">åˆ‡æ›è‡³è€ƒè©•æ¨¡å¼</button>
                <button id="submitAnswerBtn" class="action-btn btn-submit hidden">ç¹³äº¤è¨ºæ–·å ±å‘Š</button>
                <button id="toPracticeBtn" class="action-btn btn-switch hidden" onclick="switchModeToPractice()">åˆ‡æ›è‡³ç·´ç¿’æ¨¡å¼</button>
                <button id="setupGuideBtn" class="action-btn btn-guide hidden" onclick="openSetupGuide()">â˜ï¸ é›²ç«¯è¨­å®šæ•™å­¸</button>
            </div>
        </div>

        <div class="meter-area">
            <svg id="meterSvg" width="300" height="600" viewBox="0 0 300 600">
                <defs>
                    <g id="plug-red"><rect x="-6" y="-15" width="12" height="30" rx="3" fill="#e74c3c" stroke="#c0392b" stroke-width="1"/><circle cx="0" cy="18" r="3" fill="#bdc3c7"/></g>
                    <g id="plug-black"><rect x="-6" y="-15" width="12" height="30" rx="3" fill="#2c3e50" stroke="#000" stroke-width="1"/><circle cx="0" cy="18" r="3" fill="#bdc3c7"/></g>
                    <g id="probe-handle-red"><rect x="-5" y="-40" width="10" height="60" rx="2" fill="#e74c3c" stroke="#c0392b"/><rect x="-2" y="20" width="4" height="20" fill="#95a5a6"/></g>
                    <g id="probe-handle-black"><rect x="-5" y="-40" width="10" height="60" rx="2" fill="#2c3e50" stroke="#000"/><rect x="-2" y="20" width="4" height="20" fill="#95a5a6"/></g>
                </defs>
                <g id="multimeter" transform="translate(25, 20)">
                    <rect x="0" y="0" width="250" height="400" class="meter-body"/>
                    <rect x="15" y="120" width="220" height="225" rx="10" class="meter-face-plate"/>
                    <rect x="25" y="25" width="200" height="80" rx="5" class="meter-screen"/>
                    <text id="meter-display" x="210" y="85" text-anchor="end" font-size="40" class="meter-text" fill="#2c3e50"></text>
                    <g id="meter-scales" transform="translate(125, 240)"></g>
                    <g id="meter-knob" transform="translate(125, 240)">
                        <path d="M -12 -35 L 12 -35 L 15 35 L -15 35 Z" rx="10" class="meter-knob-body" /><circle cx="0" cy="0" r="18" class="meter-knob-body"/><circle cx="0" cy="-25" r="3" class="meter-knob-indicator"/><line x1="-5" y1="10" x2="5" y2="10" class="meter-knob-grip"/><line x1="-8" y1="15" x2="8" y2="15" class="meter-knob-grip"/><line x1="-10" y1="20" x2="10" y2="20" class="meter-knob-grip"/>
                    </g>
                    <g id="jack-com" transform="translate(60, 370)"><circle cx="0" cy="0" r="12" class="meter-jack"/><circle cx="0" cy="0" r="8" class="meter-jack-inner"/><text x="0" y="25" text-anchor="middle" font-size="12" font-weight="bold" fill="#ecf0f1">COM</text></g>
                    <g id="jack-volts" transform="translate(125, 370)"><circle cx="0" cy="0" r="12" class="meter-jack"/><circle cx="0" cy="0" r="8" class="meter-jack-inner"/><text x="0" y="25" text-anchor="middle" font-size="12" font-weight="bold" fill="#d35400">V/Î©</text></g>
                    <g id="jack-amps" transform="translate(190, 370)"><circle cx="0" cy="0" r="12" class="meter-jack"/><circle cx="0" cy="0" r="8" class="meter-jack-inner"/><text x="0" y="25" text-anchor="middle" font-size="12" font-weight="bold" fill="#ecf0f1">20A</text></g>
                </g>
                <path id="wire-red" d="M 0 0" stroke="#e74c3c" stroke-width="4" fill="none" />
                <path id="wire-black" d="M 0 0" stroke="#2c3e50" stroke-width="4" fill="none" />
                <g id="plug-red-obj" transform="translate(80, 470)" class="probe-plug"><use href="#plug-red"/></g>
                <g id="plug-black-obj" transform="translate(50, 470)" class="probe-plug"><use href="#plug-black"/></g>
                <g id="tip-red-obj" transform="translate(200, 470)" class="probe-tip"><use href="#probe-handle-red"/></g>
                <g id="tip-black-obj" transform="translate(230, 470)" class="probe-tip"><use href="#probe-handle-black"/></g>
            </svg>
        </div>
        
        <div id="faultPanel">
            <h3>ğŸ”© æ•…éšœè¨­å®š (æ•™å¸«æ¨¡å¼)</h3>
            <label>æ˜“ç†”çµ²: <select id="faultFuseLink" onchange="setFault()"><option value="Normal">æ­£å¸¸</option><option value="Open">æ–·è·¯</option></select></label>
            <label>ä¿éšªçµ²: <select id="faultFuse" onchange="setFault()"><option value="Normal">æ­£å¸¸</option><option value="Open">æ–·è·¯</option></select></label>
            <label>ç¹¼é›»å™¨ç·šåœˆ: <select id="faultRelayCoil" onchange="setFault()"><option value="Normal">æ­£å¸¸</option><option value="Open">æ–·è·¯</option></select></label>
            <label>ç¹¼é›»å™¨é–‹é—œ: <select id="faultRelaySwitch" onchange="setFault()"><option value="Normal">æ­£å¸¸</option><option value="Fail">æ¥è§¸ä¸è‰¯</option></select></label>
            <label>æŒ‰éˆ•é–‹é—œ: <select id="faultBtnSwitch" onchange="setFault()"><option value="Normal">æ­£å¸¸</option><option value="Open">å…§éƒ¨æ–·è·¯</option></select></label>
            <label>å–‡å­ 1: <select id="faultHorn1" onchange="setFault()"><option value="Normal">æ­£å¸¸</option><option value="Open">å…§éƒ¨æ–·è·¯</option></select></label>
            <label>å–‡å­ 2: <select id="faultHorn2" onchange="setFault()"><option value="Normal">æ­£å¸¸</option><option value="Open">å…§éƒ¨æ–·è·¯</option></select></label>
        </div>
    </div>

    <script>
        const TEACHER_GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbww4yP6wiWC03CFndJNKCj8gCKWDfdmUNRw_ZbocMfQDTY6cDmQnWnJvxW6qADasho3XA/exec';

        function openSetupGuide() {
            const w = window.open('', '_blank', 'width=800,height=600');
            const html = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>Google è©¦ç®—è¡¨ä¸Šå‚³è¨­å®šæ•™å­¸</title><style>body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; line-height: 1.6; color: #333; } h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; } ol { padding-left: 20px; } li { margin-bottom: 10px; } code { background: #f1f1f1; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #e74c3c; } pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: monospace; } .highlight { color: #f1c40f; font-weight: bold; }</style></head><body><h2>â˜ï¸ å¦‚ä½•è¨­å®šæˆç¸¾ä¸Šå‚³è‡³ Google è©¦ç®—è¡¨</h2><p>è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿå»ºç«‹å¾Œç«¯æ¥æ”¶ç¨‹å¼ï¼Œå®Œæˆå¾Œå³å¯è®“å­¸ç”Ÿä¸Šå‚³è€ƒè©•çµæœã€‚</p><ol><li>åœ¨ Google Drive å»ºç«‹ä¸€å€‹æ–°çš„ <strong>Google è©¦ç®—è¡¨</strong>ã€‚</li><li>åœ¨ç¬¬ä¸€åˆ—å»ºç«‹æ¨™é¡Œï¼š<code>æ™‚é–“</code>, <code>ç­ç´š</code>, <code>å§“å</code>, <code>åº§è™Ÿ</code>, <code>è¨ºæ–·çµæœ</code>, <code>æ­£ç¢ºç­”æ¡ˆ</code>, <code>æ˜¯å¦é€šé</code>ã€‚</li><li>é»æ“Šä¸Šæ–¹é¸å–® <strong>æ“´å……åŠŸèƒ½ (Extensions)</strong> &gt; <strong>Apps Script</strong>ã€‚</li><li>å°‡ç·¨è¼¯å™¨å…§çš„ç¨‹å¼ç¢¼å…¨éƒ¨åˆªé™¤ï¼Œè²¼ä¸Šä»¥ä¸‹ä»£ç¢¼ï¼š</li></ol><pre>function doPost(e) { var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet(); var data = JSON.parse(e.postData.contents); var timestamp = new Date(); sheet.appendRow([ timestamp, data.studentClass, data.studentName, data.seatNumber, data.userDiagnosis, data.correctFault, data.isPass ? "é€šé" : "æœªé€šé" ]); return ContentService.createTextOutput(JSON.stringify({status: 'success'})).setMimeType(ContentService.MimeType.JSON);}</pre><ol start="5"><li>é»æ“Šå³ä¸Šè§’ <strong>éƒ¨ç½² (Deploy)</strong> &gt; <strong>æ–°å¢éƒ¨ç½² (New deployment)</strong>ã€‚</li><li>é»æ“Šé½’è¼ªåœ–ç¤º &gt; é¸æ“‡ <strong>ç¶²é æ‡‰ç”¨ç¨‹å¼ (Web app)</strong>ã€‚</li><li><strong>âš ï¸ é—œéµè¨­å®šï¼š</strong><ul><li>åŸ·è¡Œèº«åˆ† (Execute as)ï¼š<strong>æˆ‘ (Me)</strong></li><li>èª°å¯ä»¥å­˜å– (Who has access)ï¼š<span class="highlight">ä»»ä½•äºº (Anyone)</span> &lt;-- å‹™å¿…é¸é€™å€‹ï¼</li></ul></li><li>é»æ“Š <strong>éƒ¨ç½²</strong>ï¼Œè¤‡è£½ç”¢ç”Ÿçš„ <strong>ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (Web App URL)</strong>ã€‚</li><li>å›åˆ°æœ¬æ¨¡æ“¬å™¨çš„ç¨‹å¼ç¢¼ä¸­ï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹çš„ <code>const TEACHER_GOOGLE_SCRIPT_URL = '';</code>ï¼Œå°‡ç¶²å€è²¼å…¥å–®å¼•è™Ÿä¸­ã€‚</li></ol><p>å®Œæˆå¾Œï¼Œé‡æ–°æ•´ç†æ¨¡æ“¬å™¨ç¶²é ï¼Œå³å¯æ¸¬è©¦ä¸Šå‚³åŠŸèƒ½ã€‚</p></body></html>`;
            w.document.write(html); w.document.close();
        }

        const faultOptions = [
            { id: 'normal', label: 'é›»è·¯åŠŸèƒ½æ­£å¸¸' },
            { id: 'fuse_link_open', label: 'æ˜“ç†”çµ²æ–·è·¯' },
            { id: 'fuse_open', label: 'ä¿éšªçµ²æ–·è·¯' },
            { id: 'relay_coil_open', label: 'ç¹¼é›»å™¨ç·šåœˆæ–·è·¯ (85-86)' },
            { id: 'relay_switch_fail', label: 'ç¹¼é›»å™¨é–‹é—œæ¥é»æ•…éšœ (30-87)' },
            { id: 'btn_open', label: 'æŒ‰éˆ•é–‹é—œå…§éƒ¨æ–·è·¯' },
            { id: 'horn1_open', label: 'ä¸Šå–‡å­å…§éƒ¨ç·šåœˆæ–·è·¯' },
            { id: 'horn2_open', label: 'ä¸‹å–‡å­å…§éƒ¨ç·šåœˆæ–·è·¯' }
        ];
        
        let currentActiveFault = 'normal';
        let studentInfo = { class: '', name: '', seat: '' };
        let isAssessmentMode = false;
        let lastResultData = null;

        function choosePracticeMode() {
            isAssessmentMode = false;
            currentActiveFault = 'normal';
            document.getElementById('modeDisplay').textContent = "ç·´ç¿’æ¨¡å¼";
            document.getElementById('modeDisplay').className = "mode-indicator mode-practice";
            document.getElementById('studentDisplay').textContent = "è‡ªç”±ç·´ç¿’";
            document.getElementById('faultBtn').classList.remove('hidden');
            document.getElementById('toExamBtn').classList.remove('hidden');
            document.getElementById('setupGuideBtn').classList.remove('hidden'); 
            document.getElementById('submitAnswerBtn').classList.add('hidden');
            document.getElementById('toPracticeBtn').classList.add('hidden');
            document.getElementById('loginModal').classList.add('hidden');
            runSimulation();
        }

        function chooseExamMode() {
            document.getElementById('stepSelectMode').classList.add('hidden');
            document.getElementById('stepLogin').classList.remove('hidden');
        }

        function backToModeSelect() {
            document.getElementById('stepLogin').classList.add('hidden');
            document.getElementById('stepSelectMode').classList.remove('hidden');
        }

        function switchModeToExam() {
            if(confirm("ç¢ºå®šè¦åˆ‡æ›è‡³è€ƒè©•æ¨¡å¼å—ï¼Ÿé€™å°‡æ¸…é™¤ç›®å‰çš„é€£ç·šã€‚")) {
                setModeUI(true);
                resetSimulation();
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('stepSelectMode').classList.add('hidden');
                document.getElementById('stepLogin').classList.remove('hidden');
            }
        }

        function switchModeToPractice() {
            if(confirm("ç¢ºå®šè¦åˆ‡æ›è‡³ç·´ç¿’æ¨¡å¼å—ï¼Ÿé€™å°‡æ”¾æ£„ç›®å‰çš„é€²åº¦ã€‚")) {
                resetSimulation();
                startPracticeMode();
                isAssessmentMode = false;
                currentActiveFault = 'normal';
                document.getElementById('modeDisplay').textContent = "ç·´ç¿’æ¨¡å¼";
                document.getElementById('modeDisplay').className = "mode-indicator mode-practice";
                document.getElementById('studentDisplay').textContent = "è‡ªç”±ç·´ç¿’";
                document.getElementById('faultBtn').classList.remove('hidden');
                document.getElementById('toExamBtn').classList.remove('hidden');
                document.getElementById('setupGuideBtn').classList.remove('hidden');
                document.getElementById('submitAnswerBtn').classList.add('hidden');
                document.getElementById('toPracticeBtn').classList.add('hidden');
                resetFaultPanelUI();
                updateFaultStateFromRandom();
                runSimulation();
            }
        }

        function setModeUI(isExam) {
            isAssessmentMode = isExam;
            document.getElementById('faultPanel').classList.remove('visible');
            const faultBtn = document.getElementById('faultBtn');
            const submitBtn = document.getElementById('submitAnswerBtn');
            const toExamBtn = document.getElementById('toExamBtn');
            const toPracticeBtn = document.getElementById('toPracticeBtn');
            const guideBtn = document.getElementById('setupGuideBtn');

            if (isExam) {
                faultBtn.classList.add('hidden');
                toExamBtn.classList.add('hidden');
                guideBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                toPracticeBtn.classList.remove('hidden');
            } else {
                faultBtn.classList.remove('hidden');
                toExamBtn.classList.remove('hidden');
                guideBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                toPracticeBtn.classList.add('hidden');
            }
        }

        function resetSimulation() {
            const wireLayer = document.getElementById('wire-layer');
            wireLayer.innerHTML = '';
            connections = [];
            isDrawing = false;
            currentPath = [];
            document.querySelectorAll('.conn-point.active').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.flowing').forEach(el => el.classList.remove('flowing'));
            runSimulation();
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            studentInfo.class = document.getElementById('inputClass').value;
            studentInfo.name = document.getElementById('inputName').value;
            studentInfo.seat = document.getElementById('inputSeat').value;
            const paperCode = parseInt(document.getElementById('inputPaper').value);
            
            if(!studentInfo.name) { alert("è«‹è¼¸å…¥å§“å"); return; }
            
            const seatNum = parseInt(studentInfo.seat) || 1;
            const fixedIndex = (seatNum + paperCode) % faultOptions.length;
            currentActiveFault = faultOptions[fixedIndex].id;
            updateFaultStateFromRandom();

            document.getElementById('modeDisplay').textContent = "è€ƒè©•æ¨¡å¼";
            document.getElementById('modeDisplay').className = "mode-indicator mode-exam";
            document.getElementById('studentDisplay').textContent = `è€ƒç”Ÿï¼š${studentInfo.class} ${studentInfo.name} (${studentInfo.seat})`;
            setModeUI(true);
            document.getElementById('loginModal').classList.add('hidden');
            
            runSimulation();
        });

        let faultState = { fuse_link: 'Normal', fuse: 'Normal', relay_coil: 'Normal', relay_switch: 'Normal', btn_switch: 'Normal', horn1: 'Normal', horn2: 'Normal' };

        function resetFaultPanelUI() {
            document.getElementById('faultFuseLink').value = 'Normal';
            document.getElementById('faultFuse').value = 'Normal';
            document.getElementById('faultRelayCoil').value = 'Normal';
            document.getElementById('faultRelaySwitch').value = 'Normal';
            document.getElementById('faultBtnSwitch').value = 'Normal';
            document.getElementById('faultHorn1').value = 'Normal';
            document.getElementById('faultHorn2').value = 'Normal';
        }

        function setFault() {
            if(isAssessmentMode) return;
            faultState.fuse_link = document.getElementById('faultFuseLink').value;
            faultState.fuse = document.getElementById('faultFuse').value;
            faultState.relay_coil = document.getElementById('faultRelayCoil').value;
            faultState.relay_switch = document.getElementById('faultRelaySwitch').value;
            faultState.btn_switch = document.getElementById('faultBtnSwitch').value;
            faultState.horn1 = document.getElementById('faultHorn1').value;
            faultState.horn2 = document.getElementById('faultHorn2').value;
            
            if(faultState.fuse_link === 'Open') currentActiveFault = 'fuse_link_open';
            else if(faultState.fuse === 'Open') currentActiveFault = 'fuse_open';
            else if(faultState.relay_coil === 'Open') currentActiveFault = 'relay_coil_open';
            else if(faultState.relay_switch === 'Fail') currentActiveFault = 'relay_switch_fail';
            else if(faultState.btn_switch === 'Open') currentActiveFault = 'btn_open';
            else if(faultState.horn1 === 'Open') currentActiveFault = 'horn1_open';
            else if(faultState.horn2 === 'Open') currentActiveFault = 'horn2_open';
            else currentActiveFault = 'normal';
            
            runSimulation();
        }
        
        function updateFaultStateFromRandom() {
            faultState = { fuse_link: 'Normal', fuse: 'Normal', relay_coil: 'Normal', relay_switch: 'Normal', btn_switch: 'Normal', horn1: 'Normal', horn2: 'Normal' };
            if(currentActiveFault === 'fuse_link_open') faultState.fuse_link = 'Open';
            if(currentActiveFault === 'fuse_open') faultState.fuse = 'Open';
            if(currentActiveFault === 'relay_coil_open') faultState.relay_coil = 'Open';
            if(currentActiveFault === 'relay_switch_fail') faultState.relay_switch = 'Fail';
            if(currentActiveFault === 'btn_open') faultState.btn_switch = 'Open';
            if(currentActiveFault === 'horn1_open') faultState.horn1 = 'Open';
            if(currentActiveFault === 'horn2_open') faultState.horn2 = 'Open';
        }

        document.getElementById('faultBtn').addEventListener('click', () => { document.getElementById('faultPanel').classList.toggle('visible'); });
        document.getElementById('submitAnswerBtn').addEventListener('click', () => { document.getElementById('quizModal').classList.remove('hidden'); });
        document.getElementById('cancelSubmitBtn').addEventListener('click', () => { document.getElementById('quizModal').classList.add('hidden'); });

        document.getElementById('confirmSubmitBtn').addEventListener('click', () => {
            const selected = document.querySelector('input[name="diagnosis"]:checked');
            if (!selected) { alert("è«‹é¸æ“‡ä¸€å€‹è¨ºæ–·çµæœï¼"); return; }
            const userChoice = selected.value;
            const isCorrect = (userChoice === currentActiveFault);
            const resultTitle = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');
            const resultDetails = document.getElementById('resultDetails');
            
            if (isCorrect) { resultTitle.textContent = "ğŸ‰ æ­å–œï¼è¨ºæ–·æ­£ç¢º"; resultTitle.className = "result-success"; resultText.textContent = "æ‚¨æˆåŠŸæ‰¾å‡ºäº†é›»è·¯çš„å•é¡Œï¼"; }
            else { resultTitle.textContent = "âŒ è¨ºæ–·éŒ¯èª¤"; resultTitle.className = "result-fail"; resultText.textContent = "å¾ˆéºæ†¾ï¼Œåˆ¤æ–·ä¸æ­£ç¢ºã€‚"; }
            
            const correctLabel = faultOptions.find(f => f.id === currentActiveFault).label;
            const userLabel = faultOptions.find(f => f.id === userChoice).label;
            resultDetails.innerHTML = `<strong>è€ƒç”Ÿï¼š</strong>${studentInfo.class} ${studentInfo.name}<br><strong>æ‚¨çš„ç­”æ¡ˆï¼š</strong>${userLabel}<br><strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong><span style="color:red">${correctLabel}</span>`;
            
            lastResultData = { studentClass: studentInfo.class, studentName: studentInfo.name, seatNumber: studentInfo.seat, userDiagnosis: userLabel, correctFault: correctLabel, isPass: isCorrect };
            document.getElementById('quizModal').classList.add('hidden');
            document.getElementById('resultModal').classList.remove('hidden');
        });

        function downloadCSV() {
            if(!lastResultData) return;
            const bom = "\uFEFF"; 
            const header = "ç­ç´š,å§“å,åº§è™Ÿ,è€ƒç”Ÿè¨ºæ–·,æ­£ç¢ºç­”æ¡ˆ,çµæœ\n";
            const row = `${lastResultData.studentClass},${lastResultData.studentName},${lastResultData.seatNumber},${lastResultData.userDiagnosis},${lastResultData.correctFault},${lastResultData.isPass ? 'é€šé' : 'æœªé€šé'}\n`;
            const blob = new Blob([bom + header + row], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `è¨ºæ–·çµæœ_${lastResultData.studentName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function uploadToGoogle() {
            if(!lastResultData) return;
            if(!TEACHER_GOOGLE_SCRIPT_URL || TEACHER_GOOGLE_SCRIPT_URL.length < 10) { alert("éŒ¯èª¤ï¼šæ•™å¸«å°šæœªè¨­å®š Google Script ç¶²å€ã€‚"); return; }
            const btn = document.querySelector('.btn-upload');
            btn.textContent = "ä¸Šå‚³ä¸­...";
            btn.disabled = true;
            fetch(TEACHER_GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(lastResultData)
            }).then(() => { alert("æˆç¸¾å·²ç™¼é€è‡³é›²ç«¯ï¼"); btn.textContent = "ä¸Šå‚³æˆåŠŸ"; }).catch(err => { console.error(err); alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è…³æœ¬è¨­å®šã€‚"); btn.textContent = "ä¸Šå‚³å¤±æ•—"; btn.disabled = false; });
        }

        const CircuitEngine = {
            componentResistance: { 'fusible_link': 0.1, 'fuse': 0.1, 'relay_coil': 80.0, 'relay_switch': 0.1, 'horn': 4.0, 'button': 0.1 },
            isConnected: function(n1, n2, graph) {
                if (n1 === n2) return true;
                if (!graph[n1]) return false;
                let queue = [n1], visited = new Set([n1]);
                while(queue.length > 0) {
                    let node = queue.shift();
                    if(node === n2) return true;
                    if(graph[node]) { for(let n of graph[node]) if(!visited.has(n)) { visited.add(n); queue.push(n); } }
                }
                return false;
            },
            buildGraph: function(buttonPressed, relayClosed) {
                let adj = {};
                const addEdge = (u, v) => { if(!adj[u]) adj[u]=[]; if(!adj[v]) adj[v]=[]; adj[u].push(v); adj[v].push(u); };
                connections.forEach(conn => addEdge(conn.start, conn.end));
                if (faultState.fuse_link === 'Normal') addEdge('fuse_link_in', 'fuse_link_out');
                if (faultState.fuse === 'Normal') addEdge('fuse_in', 'fuse_out'); 
                if(relayClosed && faultState.relay_switch === 'Normal') addEdge('relay_30', 'relay_87');
                if(buttonPressed && faultState.btn_switch === 'Normal') addEdge('btn_in', 'btn_out');
                return adj;
            },
            getVoltageAtNode: function(targetNode, buttonPressed, relayClosed) {
                if (targetNode === 'bat_neg' || targetNode === 'btn_out' || targetNode.includes('_gnd')) return 0.0;
                let graph = this.buildGraph(buttonPressed, relayClosed);
                if (faultState.relay_coil === 'Normal') {
                    if(!graph['relay_85']) graph['relay_85']=[]; graph['relay_85'].push('relay_86');
                    if(!graph['relay_86']) graph['relay_86']=[]; graph['relay_86'].push('relay_85');
                }
                let connectedToPos = this.isConnected('bat_pos', targetNode, graph);
                let connectedToNeg = this.isConnected('bat_neg', targetNode, graph) || this.isConnected('btn_out', targetNode, graph);
                if (!connectedToPos) return 0.0; 
                if (!connectedToNeg) return 12.0; 
                const lowSideNodes = ['relay_85', 'btn_in'];
                if (lowSideNodes.includes(targetNode) && this.isConnected(targetNode, 'btn_out', graph)) return 0.0; 
                return 12.0; 
            },
            getResistance: function(n1, n2) {
                if (n1 === n2) return 0.0;
                const nodes = [n1, n2].sort(); const a = nodes[0]; const b = nodes[1];
                if ((a === 'relay_85' && b === 'relay_86') || (a === 'relay_86' && b === 'relay_85')) return faultState.relay_coil === 'Open' ? -1 : 80.0;
                const isHornPair = (hIn, hGnd) => (a === hIn && b === hGnd) || (a === hGnd && b === hIn);
                if (isHornPair('horn1_in', 'horn1_gnd')) return faultState.horn1 === 'Open' ? -1 : 4.0;
                if (isHornPair('horn2_in', 'horn2_gnd')) return faultState.horn2 === 'Open' ? -1 : 4.0;
                const gndNodes = ['bat_neg', 'btn_out', 'horn1_gnd', 'horn2_gnd'];
                if ((a.includes('horn') && gndNodes.includes(b)) || (b.includes('horn') && gndNodes.includes(a))) {
                     return (faultState.horn1 === 'Open' && a.includes('horn1')) || (faultState.horn2 === 'Open' && a.includes('horn2')) ? -1 : 4.0;
                }
                if (a.includes('fuse_link') && b.includes('fuse_link')) return faultState.fuse_link === 'Open' ? -1 : 0.1;
                if (a.includes('fuse') && b.includes('fuse') && !a.includes('link')) return faultState.fuse === 'Open' ? -1 : 0.1;
                if ((a === 'relay_30' && b === 'relay_87') || (a === 'relay_87' && b === 'relay_30')) {
                    let isActive = document.getElementById('relay').classList.contains('relay-active');
                    if (isActive && faultState.relay_switch === 'Fail') return -1;
                    return isActive ? 0.1 : -1;
                }
                if ((a === 'btn_in' && b === 'btn_out') || (a === 'btn_out' && b === 'btn_in')) {
                    if (isButtonPressed && faultState.btn_switch === 'Open') return -1;
                    return isButtonPressed ? 0.1 : -1;
                }
                let graph = this.buildGraph(isButtonPressed, document.getElementById('relay').classList.contains('relay-active'));
                if (this.isConnected(a, b, graph)) return 0.0;
                return -1; 
            }
        };

        let isButtonPressed = false;
        const statusMsg = document.getElementById('statusMsg');
        function runSimulation() {
            let v86 = CircuitEngine.getVoltageAtNode('relay_86', isButtonPressed, false);
            let checkGnd = (node) => {
                let g = CircuitEngine.buildGraph(isButtonPressed, false);
                return CircuitEngine.isConnected(node, 'bat_neg', g) || CircuitEngine.isConnected(node, 'btn_out', g);
            };
            let p85_gnd = checkGnd('relay_85');
            let p86_gnd = checkGnd('relay_86');
            let v85 = CircuitEngine.getVoltageAtNode('relay_85', isButtonPressed, false);
            let coilOK = faultState.relay_coil === 'Normal';
            let relayEnergized = coilOK && ((v86 > 10 && p85_gnd) || (v85 > 10 && p86_gnd));

            const relayGroup = document.getElementById('relay');
            if (relayEnergized) relayGroup.classList.add('relay-active');
            else relayGroup.classList.remove('relay-active');

            let switchOK = faultState.relay_switch === 'Normal';
            let h1Active = false, h2Active = false;
            
            if (relayEnergized && switchOK) {
                let vH1 = CircuitEngine.getVoltageAtNode('horn1_in', isButtonPressed, true);
                let vH2 = CircuitEngine.getVoltageAtNode('horn2_in', isButtonPressed, true);
                let h1OK = faultState.horn1 === 'Normal';
                let h2OK = faultState.horn2 === 'Normal';
                if (vH1 > 10 && h1OK) h1Active = true;
                if (vH2 > 10 && h2OK) h2Active = true;
            }

            const h1El = document.getElementById('horn1'); const h2El = document.getElementById('horn2');
            if (h1Active) h1El.classList.add('honking'); else h1El.classList.remove('honking');
            if (h2Active) h2El.classList.add('honking'); else h2El.classList.remove('honking');
            
            if (h1Active || h2Active) { statusMsg.innerText = "é›»è·¯é‹ä½œä¸­"; statusMsg.style.color = "#2ecc71"; }
            else { statusMsg.innerText = isAssessmentMode ? "è€ƒè©•é€²è¡Œä¸­..." : "æº–å‚™å°±ç·’"; statusMsg.style.color = "#bdc3c7"; }
            
            updateFlowAnimation(relayEnergized && switchOK);
            updateMultimeterReading(relayEnergized);
        }

        function updateFlowAnimation(relayClosed) {
            document.querySelectorAll('.flowing').forEach(el => el.classList.remove('flowing'));
            if (isAssessmentMode) return; 
            let graph = {};
            const link = (u, v) => { if(!graph[u]) graph[u]=[]; if(!graph[v]) graph[v]=[]; graph[u].push(v); graph[v].push(u); };
            connections.forEach(conn => link(conn.start, conn.end));
            if (faultState.fuse_link === 'Normal') link('fuse_link_in', 'fuse_link_out');
            if (faultState.fuse === 'Normal') link('fuse_in', 'fuse_out');
            if (faultState.relay_coil === 'Normal') link('relay_85', 'relay_86');
            if (relayClosed) link('relay_30', 'relay_87');
            if (isButtonPressed && faultState.btn_switch === 'Normal') link('btn_in', 'btn_out');
            const isPowered = (node) => { let q=[node], v=new Set([node]); while(q.length) { let n=q.shift(); if(n==='bat_pos') return true; if(graph[n]) for(let nb of graph[n]) if(!v.has(nb)){v.add(nb);q.push(nb);} } return false; };
            const isGrounded = (node) => { let q=[node], v=new Set([node]); while(q.length) { let n=q.shift(); if(n==='bat_neg'||n==='btn_out') return true; if(graph[n]) for(let nb of graph[n]) if(!v.has(nb)){v.add(nb);q.push(nb);} } return false; };
            const wires = document.querySelectorAll('.wire');
            connections.forEach((conn, index) => {
                let p1 = isPowered(conn.start) && isGrounded(conn.end);
                let p2 = isPowered(conn.end) && isGrounded(conn.start);
                let p3 = isPowered(conn.start) && isGrounded(conn.start);
                let targetHornBroken = false;
                if ((conn.end.includes('horn1') && faultState.horn1 === 'Open') || (conn.start.includes('horn1') && faultState.horn1 === 'Open')) targetHornBroken = true;
                if ((conn.end.includes('horn2') && faultState.horn2 === 'Open') || (conn.start.includes('horn2') && faultState.horn2 === 'Open')) targetHornBroken = true;
                if (!targetHornBroken && (p1 || p2 || p3)) wires[index].classList.add('flowing');
            });
            if (faultState.fuse_link === 'Normal') { if(isPowered('fuse_link_in') && isGrounded('fuse_link_out')) document.getElementById('path_fusible_link').classList.add('flowing'); }
            if (faultState.fuse === 'Normal') { if(isPowered('fuse_in') && isGrounded('fuse_out')) document.getElementById('path_fuse').classList.add('flowing'); }
            if (faultState.relay_coil === 'Normal' && ((isPowered('relay_86') && isGrounded('relay_85')) || (isPowered('relay_85') && isGrounded('relay_86')))) {
                document.getElementById('path_relay_coil_1').classList.add('flowing');
                document.getElementById('path_relay_coil_2').classList.add('flowing');
                document.getElementById('path_relay_coil_3').classList.add('flowing');
            }
            if (relayClosed && isPowered('relay_30')) {
                 document.getElementById('path_relay_sw_1').classList.add('flowing');
                 document.getElementById('path_relay_sw_2').classList.add('flowing');
            }
        }

        let probeContact = { red: null, black: null };
        function checkProbeContact() {
            const points = document.querySelectorAll('.conn-point');
            probeContact.red = null; probeContact.black = null;
            points.forEach(p => p.classList.remove('probing'));
            ['red', 'black'].forEach(color => {
                const s = probeState[color];
                const pt = meterSvg.createSVGPoint();
                const angleRad = s.angle * Math.PI / 180;
                pt.x = s.x - 40 * Math.sin(angleRad); pt.y = s.y + 40 * Math.cos(angleRad);
                const CTM = meterSvg.getScreenCTM();
                const screenTipX = pt.x * CTM.a + CTM.e; const screenTipY = pt.y * CTM.d + CTM.f;
                points.forEach(p => {
                    const pRect = p.getBoundingClientRect();
                    const pX = pRect.left + pRect.width/2; const pY = pRect.top + pRect.height/2;
                    if (Math.sqrt(Math.pow(screenTipX - pX, 2) + Math.pow(screenTipY - pY, 2)) < 20) { probeContact[color] = p.getAttribute('data-id'); p.classList.add('probing'); }
                });
            });
            runSimulation();
        }
        function updateMultimeterReading(relayEnergized) {
            const mode = knobModes[currentModeIndex];
            const display = document.getElementById('meter-display');
            if (mode.type === 'off') { display.textContent = ""; return; }
            if (probeState.red.jack !== 'volts' || probeState.black.jack !== 'com') { display.textContent = "0.00"; return; }
            if (!probeContact.red || !probeContact.black) { if (mode.type === 'res') display.textContent = "1 ."; else display.textContent = "0.00"; return; }
            if (mode.type === 'dcv') {
                let vRed = CircuitEngine.getVoltageAtNode(probeContact.red, isButtonPressed, relayEnergized);
                let vBlack = CircuitEngine.getVoltageAtNode(probeContact.black, isButtonPressed, relayEnergized);
                let coilOk = faultState.relay_coil === 'Normal';
                if (coilOk && !isButtonPressed && probeContact.red === 'relay_85' && CircuitEngine.getVoltageAtNode('relay_86', false, false) > 10) vRed = 12.0;
                if (coilOk && !isButtonPressed && probeContact.red === 'relay_86' && CircuitEngine.getVoltageAtNode('relay_85', false, false) > 10) vRed = 12.0;
                display.textContent = (vRed - vBlack).toFixed(2);
            } else if (mode.type === 'res') {
                let r = CircuitEngine.getResistance(probeContact.red, probeContact.black);
                if (r === -1) display.textContent = "1 ."; else if (r >= 1000) display.textContent = (r/1000).toFixed(2) + "k"; else display.textContent = r.toFixed(1);
            } else { display.textContent = "0.00"; }
        }
        const meterSvg = document.getElementById('meterSvg'); const meterKnob = document.getElementById('meter-knob'); const meterDisplay = document.getElementById('meter-display'); const meterScalesGroup = document.getElementById('meter-scales'); const knobModes = [ { label: "OFF", angle: 0, type: 'off' }, { label: "2V", angle: -30, type: 'dcv' }, { label: "20V", angle: -50, type: 'dcv' }, { label: "200V", angle: -70, type: 'dcv' }, { label: "200Î©", angle: -100, type: 'res' }, { label: "2KÎ©", angle: -120, type: 'res' }, { label: "200K", angle: -140, type: 'res' }, { label: "2M", angle: -160, type: 'res' }, { label: "2mA", angle: 22, type: 'amp' }, { label: "20mA", angle: 50, type: 'amp' }, { label: "200mA", angle: 78, type: 'amp' }, { label: "20A", angle: 106, type: 'amp' }, ]; let currentModeIndex = 0; function initMeterScales() { const radiusDot = 65; const radiusText = 82; knobModes.forEach((mode, index) => { const group = document.createElementNS("http://www.w3.org/2000/svg", "g"); group.setAttribute("class", "scale-group"); group.addEventListener("click", () => setMode(index)); const rad = (mode.angle - 90) * Math.PI / 180; const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle"); dot.setAttribute("cx", radiusDot * Math.cos(rad)); dot.setAttribute("cy", radiusDot * Math.sin(rad)); dot.setAttribute("r", 2.5); dot.setAttribute("class", "scale-tick"); group.appendChild(dot); const text = document.createElementNS("http://www.w3.org/2000/svg", "text"); text.setAttribute("x", radiusText * Math.cos(rad)); text.setAttribute("y", radiusText * Math.sin(rad)); text.setAttribute("class", "scale-label"); text.textContent = mode.label; text.setAttribute("transform", `rotate(${mode.angle}, ${radiusText * Math.cos(rad)}, ${radiusText * Math.sin(rad)})`); text.setAttribute("dy", "0.35em"); group.appendChild(text); meterScalesGroup.appendChild(group); }); } function setMode(index) { currentModeIndex = index; meterKnob.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; meterKnob.style.transform = `translate(125px, 240px) rotate(${knobModes[index].angle}deg)`; updateMultimeterReading(false); } initMeterScales(); setMode(0); let selectedElement = null; let offset = { x: 0, y: 0 }; const jacks = { 'com': { x: 25+60, y: 20+370 }, 'volts': { x: 25+125, y: 20+370 }, 'amps': { x: 25+190, y: 20+370 } }; const probeState = { red: { plugId: 'plug-red-obj', tipId: 'tip-red-obj', wireId: 'wire-red', jack: null, plugX: 80, plugY: 470, x: 200, y: 470, angle: 0 }, black: { plugId: 'plug-black-obj', tipId: 'tip-black-obj', wireId: 'wire-black', jack: null, plugX: 50, plugY: 470, x: 230, y: 470, angle: 0 } }; function updateElementPosition(color) { const s = probeState[color]; const plug = document.getElementById(s.plugId); plug.setAttribute("transform", `translate(${s.plugX}, ${s.plugY})`); const tip = document.getElementById(s.tipId); tip.setAttribute("transform", `translate(${s.x}, ${s.y}) rotate(${s.angle})`); const wire = document.getElementById(s.wireId); const x1 = s.plugX; const y1 = s.plugY - 15; const rad = s.angle * Math.PI / 180; const tx = s.x + 40 * Math.sin(rad); const ty = s.y - 40 * Math.cos(rad); const cx = (x1 + tx) / 2; const cy = Math.max(y1, ty) + 50; wire.setAttribute('d', `M ${x1} ${y1} Q ${cx} ${cy} ${tx} ${ty}`); } updateElementPosition('red'); updateElementPosition('black'); function makeDraggable(elementId, type, color) { const elem = document.getElementById(elementId); if(type==='tip') { elem.addEventListener('dblclick', (e) => { e.stopPropagation(); probeState[color].angle = (probeState[color].angle + 15) % 360; updateElementPosition(color); checkProbeContact(); }); } elem.addEventListener('mousedown', (e) => { const CTM = meterSvg.getScreenCTM(); const mx = (e.clientX - CTM.e) / CTM.a; const my = (e.clientY - CTM.f) / CTM.d; if(type === 'tip') { offset.x = mx - probeState[color].x; offset.y = my - probeState[color].y; } else { offset.x = mx - probeState[color].plugX; offset.y = my - probeState[color].plugY; } selectedElement = { type: type, color: color }; elem.style.cursor = "grabbing"; }); } makeDraggable('plug-red-obj', 'plug', 'red'); makeDraggable('plug-black-obj', 'plug', 'black'); makeDraggable('tip-red-obj', 'tip', 'red'); makeDraggable('tip-black-obj', 'tip', 'black'); window.addEventListener('mousemove', (e) => { if (selectedElement) { e.preventDefault(); const CTM = meterSvg.getScreenCTM(); const mx = (e.clientX - CTM.e) / CTM.a; const my = (e.clientY - CTM.f) / CTM.d; const s = probeState[selectedElement.color]; if (selectedElement.type === 'tip') { s.x = mx - offset.x; s.y = my - offset.y; checkProbeContact(); } else { s.plugX = mx - offset.x; s.plugY = my - offset.y; s.jack = null; } updateElementPosition(selectedElement.color); } }); window.addEventListener('mouseup', (e) => { try { if (selectedElement) { const s = probeState[selectedElement.color]; const elem = document.getElementById(selectedElement.type === 'plug' ? s.plugId : s.tipId); elem.style.cursor = "grab"; if (selectedElement.type === 'plug') { const jacksAbs = { 'com': {x:85,y:390}, 'volts':{x:150,y:390}, 'amps':{x:215,y:390} }; const tipX = s.plugX; const tipY = s.plugY + 18; let snapped = false; for (const [key, pos] of Object.entries(jacksAbs)) { if (Math.sqrt(Math.pow(tipX - pos.x, 2) + Math.pow(tipY - pos.y, 2)) < 30) { s.plugX = pos.x; s.plugY = pos.y - 18; s.jack = key; snapped = true; break; } } if(!snapped) s.jack = null; updateElementPosition(selectedElement.color); runSimulation(); } } } catch(err) { console.error(err); } finally { selectedElement = null; } });
        const circuitSvg = document.getElementById('circuitSvg'); const wireLayer = document.getElementById('wire-layer'); const points = document.querySelectorAll('.conn-point'); const btnGroup = document.getElementById('button'); const btnHitbox = document.getElementById('btn-hitbox'); let isDrawing = false; let currentPath = []; let previewLine = null; let startNodeId = null; let connections = []; function getCircuitMousePos(evt) { const CTM = circuitSvg.getScreenCTM(); return { x: (evt.clientX - CTM.e) / CTM.a, y: (evt.clientY - CTM.f) / CTM.d }; } function getPointPosition(circle) { const CTM = circuitSvg.getScreenCTM(); const r = circle.getBoundingClientRect(); return { x: (r.left + r.width/2 - CTM.e) / CTM.a, y: (r.top + r.height/2 - CTM.f) / CTM.d }; } function applySmartSnap(prevPoint, currPoint) { if (!prevPoint) return currPoint; const dx = currPoint.x - prevPoint.x, dy = currPoint.y - prevPoint.y; const angle = Math.abs(Math.atan2(dy, dx) * 180 / Math.PI); if (angle < 5 || angle > 175) return { x: currPoint.x, y: prevPoint.y }; if (Math.abs(angle - 90) < 5) return { x: prevPoint.x, y: currPoint.y }; return currPoint; }
        points.forEach(point => { point.addEventListener('mousedown', (e) => { e.stopPropagation(); const pos = getPointPosition(point); const pid = point.getAttribute('data-id'); if (!isDrawing) { isDrawing = true; startNodeId = pid; currentPath = [pos]; previewLine = document.createElementNS("http://www.w3.org/2000/svg", "polyline"); previewLine.setAttribute("class", "wire-preview"); previewLine.setAttribute("points", `${pos.x},${pos.y} ${pos.x},${pos.y}`); wireLayer.appendChild(previewLine); point.classList.add('active'); } else { if (pid === startNodeId) return; currentPath.push(pos); connections.push({ start: startNodeId, end: pid }); const realWire = document.createElementNS("http://www.w3.org/2000/svg", "polyline"); realWire.setAttribute("class", "wire"); const pointsStr = currentPath.map(p => `${p.x},${p.y}`).join(' '); realWire.setAttribute("points", pointsStr); wireLayer.appendChild(realWire); isDrawing = false; currentPath = []; startNodeId = null; if (previewLine) { previewLine.remove(); previewLine = null; } document.querySelectorAll('.conn-point.active').forEach(p => p.classList.remove('active')); runSimulation(); } }); });
        circuitSvg.addEventListener('mousedown', (e) => { if (isDrawing) { let mp = getCircuitMousePos(e); mp = applySmartSnap(currentPath[currentPath.length - 1], mp); currentPath.push(mp); if (previewLine) previewLine.setAttribute("points", currentPath.map(p => `${p.x},${p.y}`).join(' ') + ` ${mp.x},${mp.y}`); } });
        circuitSvg.addEventListener('mousemove', (e) => { if (isDrawing && previewLine) { let mp = getCircuitMousePos(e); mp = applySmartSnap(currentPath[currentPath.length - 1], mp); previewLine.setAttribute("points", currentPath.map(p => `${p.x},${p.y}`).join(' ') + ` ${mp.x},${mp.y}`); } });
        circuitSvg.addEventListener('contextmenu', (e)=>{ e.preventDefault(); isDrawing=false; currentPath = []; if(previewLine){previewLine.remove(); previewLine=null;} document.querySelectorAll('.conn-point.active').forEach(p => p.classList.remove('active')); });
        document.getElementById('clearBtn').addEventListener('click', () => { if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é€£ç·šå—ï¼Ÿ')) { wireLayer.innerHTML = ''; connections = []; isDrawing = false; currentPath = []; if(previewLine) { previewLine.remove(); previewLine = null; } document.querySelectorAll('.conn-point.active').forEach(p => p.classList.remove('active')); runSimulation(); } });
        btnHitbox.addEventListener('mousedown', (e) => { e.stopPropagation(); btnGroup.classList.add('btn-pressed'); isButtonPressed = true; runSimulation(); });
        window.addEventListener('mouseup', () => { if(isButtonPressed) { btnGroup.classList.remove('btn-pressed'); isButtonPressed = false; runSimulation(); } });
    </script>
</body>
</html>